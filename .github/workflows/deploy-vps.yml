name: Deploy VPS (Helix)

on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: helix-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ vars.VPS_HOST }}
      VPS_USER: ${{ vars.VPS_USER }}
      VPS_PORT: ${{ vars.VPS_PORT }}
      HELIX_DIR: ${{ vars.VPS_HELIX_DIR }}

    steps:
      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          : "${VPS_HOST:?Missing GitHub Actions variable VPS_HOST}"
          : "${VPS_USER:?Missing GitHub Actions variable VPS_USER}"
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          PORT="${VPS_PORT:-22}"
          ssh-keyscan -p "$PORT" -H "$VPS_HOST" >> ~/.ssh/known_hosts

      - name: Deploy on VPS
        shell: bash
        run: |
          set -euo pipefail
          PORT="${VPS_PORT:-22}"

          ssh -p "$PORT" "${VPS_USER}@${VPS_HOST}" "HELIX_DIR='${HELIX_DIR}' bash -s" <<'EOF'
          set -euo pipefail

          DIR="${HELIX_DIR:-$HOME/opt/ripair/site/helix}"
          echo "[helix] deploy dir: $DIR"

          cd "$DIR"
          if [ ! -d .git ]; then
            git init
            git remote add origin https://github.com/Maxa4b/ripair-helix.git
          fi
          git remote set-url origin https://github.com/Maxa4b/ripair-helix.git
          git fetch --prune origin
          git reset --hard origin/master

          echo "[helix] backend: composer + artisan caches"
          cd backend
          echo "[helix] ensure writable storage + cache"
          if sudo -n true 2>/dev/null; then
            ME="$(whoami)"
            TARGET_GROUP="www-data"
            if ! getent group "$TARGET_GROUP" >/dev/null 2>&1; then
              TARGET_GROUP="$ME"
            fi
            sudo chown -R "$ME":"$TARGET_GROUP" storage bootstrap/cache
            sudo chmod -R ug+rwX storage bootstrap/cache
          else
            echo "[helix] WARN: sudo not available; caches may fail if permissions are too strict."
          fi
          command -v composer >/dev/null 2>&1 || { echo "[helix] ERROR: composer missing" >&2; exit 1; }
          composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader
          php artisan optimize:clear || true
          php artisan cache:clear || true
          php artisan config:cache
          php artisan event:cache || true
          php artisan route:cache || true
          php artisan view:cache || true
          php artisan queue:restart || true

          echo "[helix] frontend: npm build"
          cd ../frontend
          command -v npm >/dev/null 2>&1 || { echo "[helix] ERROR: npm missing" >&2; exit 1; }
          npm ci
          npm run build

          echo "[helix] deploy OK"
          EOF
